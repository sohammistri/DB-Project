<html>
  <head>
    <title>Memory Monitoring</title>
    <script>
      // required by react
      window.process = {
        env : 'development'
      }
      // required by giraffe
      global = window
    </script>
    <script src="https://unpkg.com/react@17.0.0/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17.0.0/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@influxdata/giraffe@0.41.0/dist/index.js"></script>
    <script src="https://unpkg.com/@influxdata/influxdb-client/dist/index.browser.js"></script>
    <script src="https://unpkg.com/@influxdata/influxdb-client-giraffe/dist/index.js"></script>
    <!-- <script src="../packages/giraffe/dist/index.js"></script> -->
    <script src="./env_browser.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.min.css">
  </head>


  <body>

    <h1>Memory Monitoring</h1>

    <fieldset>
      <legend>Host Name</legend>
      <div style="display:flex; margin-bottom: 10px;">
        <textarea id="hostName" style="flex: 1" rows="2"
        >Shabnams-MacBook-Pro.local</textarea>
      </div>
    </fieldset>

    <fieldset>
      <legend>Used Memory Percentage</legend>
      <div style="width: 100%;height: 200px; border: 1px solid grey; margin-bottom: 10px;" id="renderAreaUsed">
      </div>
    </fieldset>

    <button id="reloadButtonUsed" style="margin: 10px;">Reload</button>

    <fieldset>
      <legend>Available Memory Percentage</legend>
      <div style="width: 100%;height: 200px; border: 1px solid grey; margin-bottom: 10px;" id="renderAreaAvailable">
      </div>
    </fieldset>

    <button id="reloadButtonAvailable" style="margin: 10px;">Reload</button>


    <script>
      // get query from request parameter or use default
      fluxQueryUsed = `
          from(bucket: "Init")
      |> range(start: -30m)
      |> filter(fn: (r) => r["host"] == "Shabnams-MacBook-Pro.local")
      |> filter(fn: (r) => r["_measurement"] == "mem")
      |> filter(fn: (r) => r["_field"] == "used_percent")
      |> drop(columns: ["host"])
      |> aggregateWindow(every: 30s, fn: mean, createEmpty: false)
      |> yield(name: "mean")
        `

      fluxQueryAvailable = `
          from(bucket: "Init")
      |> range(start: -30m)
      |> filter(fn: (r) => r["host"] == "Shabnams-MacBook-Pro.local")
      |> filter(fn: (r) => r["_measurement"] == "mem")
      |> filter(fn: (r) => r["_field"] == "available_percent")
      |> drop(columns: ["host"])
      |> aggregateWindow(every: 30s, fn: mean, createEmpty: false)
      |> yield(name: "mean")
        `

      // create query API
      const {url, token, org} = window.INFLUX_ENV // loaded in ./env_browser.js
      const influxDBClient = window['@influxdata/influxdb-client']
      const influxDB = new influxDBClient.InfluxDB({url, token})
      const queryApi = influxDB.getQueryApi(org)

      // execute query and fill query data into giraffe table
      const giraffe = window['@influxdata/giraffe']
      // React functional component that renders query results or an error
      function RenderResults({error, table}){
        if (error){
          // render error message
          return React.createElement('center', null, error.toString())
        } else if (table.length) {

          console.log(table)

          // render giraffe plot
          const plotConfig = {
            table: table,
            layers: [{
              type: 'line',
              x: '_time',
              y: '_value',
              colors: ['#'+(Math.random()*0xFFFFFF<<0).toString(16)]
            }],
            valueFormatters: {
              _time: giraffe.timeFormatter({
                timeZone: 'IST',
                format: 'YYYY-MM-DD HH:mm:ss ZZ',
              }),
            }
          };
          return React.createElement(giraffe.Plot, {config: plotConfig})
        } else {
          // render empty table recevied
          return React.createElement('center', null, 'Empty Table Received')
        }
      }

      const influxDBClientGiraffe = window['@influxdata/influxdb-client-giraffe']

      function queryAndVisualize(fluxQuery, renderArea) {
        influxDBClientGiraffe.queryToTable(
          queryApi,
          fluxQuery,
          giraffe.newTable
        ). then(table => {
          console.log('queryToTable returns', table)
          ReactDOM.render(
              React.createElement(RenderResults, {table}),
              document.getElementById(renderArea)
          );
        }). catch(error => {
          console.log('queryToTable fails', error)
          ReactDOM.render(
              React.createElement(RenderResults, {error}),
              document.getElementById(renderArea)
          );
        })
      }

      queryAndVisualize(fluxQueryUsed, 'renderAreaUsed')
      document.getElementById('reloadButtonUsed').addEventListener('click', () => {
        queryAndVisualize(fluxQueryUsed, 'renderAreaUsed')
      })

      queryAndVisualize(fluxQueryAvailable, 'renderAreaAvailable')
      document.getElementById('reloadButtonAvailable').addEventListener('click', () => {
        queryAndVisualize(fluxQueryAvailable, 'renderAreaAvailable')
      })

    </script>

  </body>
</html>
